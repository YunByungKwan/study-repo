> 이 장의 내용
<br>4.1 검색 API
<br>4.2 Query DSL 이해하기
<br>4.3 Query DSL의 주요 쿼리
<br>4.4 부가적인 검색 API

- 엘라스틱서치는 인덱스에 저장된 문서를 검색할 수 있도록 다양한 검색 기능을 제공함
- 문서 -> 토큰으로 분리 By 분석기
- 분석기는 색인, 검색 시점에 둘다 사용 가능하다
- 특정 문장이 검색어로 요청되면 분석기를 통해 분석된 토큰의 일치 여부를 판단해서 그 결과에 점수(Score)를 매기고 순서를 적용하여 사용자에게 출력함

### 4.1 검색 API
> 색인 시점에 생성한 텀(Term)을 어떻게 검색 시점에 찾을 수 있을까?

- 색인 시점: Analyzer를 통해 분석된 텀을 Term, 출현 빈도, 문서번호와 같이 역색인 구조로 만들어 내부적으로 저장
- 검색 시점: 분석이 가능할 경우 분석기를 이용해 분석을 수행

#### 4.1.1 검색 질의 표현 방식
- 엘라스틱서치의 검색 API는 기본적으로 질의(Query)를 기반으로 동작
- 검색 질의에는 검색하고자 하는 각종 조건들을 명시할 수 있음
- 두가지 방식이 있다
  - URI 검색
  - Request Body 검색
    
#### 4.1.2 URI 검색
- Request Body 검색에 비해 단순하고 사용하기 편리
- 웹브라우저를 이용해 빠른 테스트 가능
- 복잡한 질의문 입력하기 힘듬
- 엘라스틱서치에서 제공하는 모든 검색 옵션을 사용할 수 없다
- 조건이 많아질수록 검색식이 매우 복잡해지고 가독성이 떨어짐
- HTTP GET 방식
  - 파라미터를 `key = value` 형태로 전달
  - URI에 검색할 칼럼과 검색어를 직접 지정하면 검색이 수행됨
- 예시 > 
    `GET movie_search/_search?q=prdtYear:2018`
- 가능한 Request Body 방식을 사용할 것

#### 4.1.3 Request Body 검색
- 질의 내용을 Query DSL(DSL)을 사용하여 JSON 형식으로 작성
- HTTP 요청 시 Body에 검색할 칼럼과 검색어를 JSON 형태로 표현해서 전달
- JSON 형태의 표현을 효율적으로 하기 위한 Query DSL 문법이 있다 (다양한 조합의 쿼리 가능)
- 예시 >
    ```
    POST movie_search/_search
    {
        "query" : {
            "term" : { "prdtYear": "2018" }
        }
    }
    ```

### 4.2 Query DSL 이해하기
- JSON 구조를 기반으로 함
- 여러 개의 질의를 조합할 수 있음
- 질의 결과에 대해 다시 검색 가능

#### 4.2.1 Query DSL 쿼리의 구조
- 요청 JSON

```
{
    "size":    // 리턴받는 결과의 개수
    "from" :   // 몇번째 문서부터 가져올지 지정
    "timeout": // 시간제한....
    "_source": // 검색시 필요한 필드만 출력하고 싶을시 사용.
    "query":   // 검색조건문
    "aggs":    // 집계 조건
    "sort":    // 어떻게 출력할지
}
```
- 응답 JSON
```
{
    "took":           // 쿼리를 실행한 시간
    "timed_out":      // 쿼리 시간이 초과할 경우
    "_shards": {
        "total":      // 쿼리를 요청한 전체 샤드의 개수
        "successful": // 검색 요청에 성공한 샤드의 개수
        "failed":     // 검색 요청에 실패한 샤드의 개수
    },
    
    "hits": {
        "total":      // 검색어에 매칭된 전체 문서의 개수
        "max_score":  // 일치하는 문서의 스코어 값 중 가장 높은 값
        "hits": []    // 각 문서 정보와 스코어 값
    }
}
```

#### 4.2.2 Query DSL 쿼리와 필터
- 쿼리(Queries) 컨텍스트
  - 예시> "Harry Potter" 같은 문장 분석
  - 전문 검색 시 사용
  - 문서가 쿼리와 얼마나 유사한지를 스코어로 계산
  - 질의가 요청될 때마다 루씬을 이용해 계산을 수행함
  - 캐싱되지 않고 디스크 연산을 수행하기 때문에 느림
  
- 필터(Filter) 컨텍스트
  - 예시> "create_year"필드의 값이 2018인지 여부
  - 쿼리의 조건과 문서가 일치하는지(Yes/No) 구분
  - 별도 스코어를 계산하지 않고 단순 매칭 여부를 검사
  - 자주 사용되는 필터의 결과는 내부적으로 캐싱함
  - 메모리 연산을 수행하기 때문에 빠름
  - 조건 검색시 사용(Yes/No)

#### 4.2.3 Query DSL의 주요 파라미터
|번호|파라미터|설명|
|:---:|:---:|:---|
|1|Multi Index 검색(",")|- 기본적으로 모든 검색 요청은 다수의 Index 및 Type 검색이 가능<br>- 다수의 비정형 데이터도 한번에 검색 가능|
|2|"from"/"size"|- 페이징 구현시 사용<br>- 페이징된 문서만 선택적으로 가져오는 것이 아니라 모든 데이터를 읽어옴|
|3|"sort"|- 스코어 값이 아닌 필드의 이름이나 가격 등으로 재정렬할 경우 사용<br>- 옵션: asc/desc|
|4|"\_source"|- 검색 결과에 대한 문서의 필드값이 \_source 항목 아래 표시됨<br>- 필터링 가능|
|5|범위검색|- 범위를 기준으로 질의해야 할 경우 사용<br>- 연산자: "lt"/"gt"/"lte"/"gte"|
|6|"operator"|- 검색 시 연산자를 명시적으로 지정할 때 사용|
|7|"minimum_should_match"|- OR 연산으로 검색시 매칭되는 텀의 최소 개수를 지정하고자 할때 사용|
|8|"fuzziness"|- 유사한 값을 찾는 쿼리로 변경할 수 있음<br>- 레벤슈타인 편집 거리 알고리즘을 기반으로 함<br>- 오차범위값: 0,1,2,AUTO|
|9|boost 설정(movieNm^2)|- 검색에서 가장 많이 사용되는 파라미터<br>- 관련성이 높은 필드나 키워드에 가중치를 더 줄 수 있게 해줌|

### 4.3 Query DSL의 주요 쿼리
|번호|쿼리 명|파라미터|옵션/속성|설명|
|:---:|:---:|:---:|:---:|:---|
|1|Match All Query|"match_all"||- 색인에 모든 문서를 검색하는 쿼리<br>- 가장 단순하며 일반적으로 색인에 저장된 문서 확인시 사용|
|2|Match Query|"match"||- 텍스트, 숫자, 날짜가 포함된 문장 -> 텀으로 분리하고 이를 이용해 검색 질의를 수행<br>- 검색어가 분석돼야 할 경우에 사용|
|3|Multi Match Query|"multi_match"||- Match Query와 기본적인 사용 방법은 동일<br>- 단일 필드가 아닌 여러 개의 필드를 대상으로 검색해야 할 때 사용|
|4|Term Query|"term"||- 별도의 분석 작업을 수행하지 않고 입력된 텍스트가 존재하는 문서를 찾음<br>- Keyword 데이터 타입을 대상으로 함<br>- 일반적으로 숫자, Keyword, 날짜 데이터를 쿼리하는데 사용<br>- 검색어를 하나의 텀으로 처리<br>-> 필드에 텀이 정확히 일치하지않으면 검색 x<br>- 영문 대소문자가 다르면 검색되지 않으므로 주의|
|5|Bool Query|"bool"|must/must_not/should/filter|- 여러 개의 쿼리를 조합할 경우에 사용|
|6|Query String|"query_string"||- 기본적으로 내장된 쿼리 분석기를 이용함<br>- 기존 텀 쿼리와 다르게 공백은 연산자로 사용되지 않음|
|7|Prefix Query|"prefix"||- 해당 접두어가 있는 모든 문서를 검색하는 데 사용|
|8|Exists Query|"exists"||- 실제 값이 존재하는 문서만 찾고 싶을 경우 사용|
|9|Wildcard Query|"wildcard"|*/?|- 검색어가 와일드카드와 일치하는 구문을 찾음<br>- 입력된 검색어는 형태소 분석이 이뤄지지 않음<br>- 와일드카드를 단어의 첫 글자로 사용하면 안됨|
|10|Nested Query||path/query|- SQL 조인과 유사<br>- Nested 데이터 타입의 필드를 검색할 때 사용|

### 4.4 부가적인 검색 API
|번호|API 명|설명|
|:---:|:---:|:---|
|1|Search Shards API|- 검색이 수행되는 노드 및 샤드에 대한 정보를 확인할 수 있음<br>|
|2|Multi Search API|- 여러 건의 검색 요청을 통합해서 한번에 요청하고 한번에 결과를 종합해서 받을 때 사용됨|
|3|Count API|- 검색된 문서의 개수만 가져올 경우 사용<br>- URI 및 Request Body 검색에서 모두 사용 가능|
|4|Validate API|- 쿼리 실행 전 쿼리의 유효성을 검증함<br>- URI 및 Request Body 검색에서 모두 사용 가능|
|5|Explain API|- 특정 문서에 대해 요청한 쿼리가 어떻게 스코어가 계산되는지 자세히 확인할 수 있음<br>- 디버깅 정보로 유용하게 활용 가능|
|6|Profile API|- 쿼리에 대한 상세한 수행 계획과 각 수행 계획별로 수행된 시간을 돌려줌<br>- 쿼리에 대한 설명이 매우 자세하기 때문에 결과가 매우 방대함<br>- 실제 쿼리가 수행된 샤드별로 프로파일 정보를 제공함|


